{% extends 'base.html.twig' %}

{% block title %}Banner Debug - {{ currentPosition|default('Main') }}{% endblock %}

{% block body %}

<div class="container-fluid mt-4">

    {% set banners = banners|default([]) %}
    {% set allPositions = allPositions|default([]) %}
    {% set stats = stats|default(null) %}
    {% set ttl = ttl|default(0) %}

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">
                        <i class="fas fa-images"></i> Banner Debug
                        <span class="badge bg-primary ms-2">{{ currentPosition|default('Main') }}</span>
                    </h3>
                    <div>
                        <a href="{{ path('debug_banner_json', {position: currentPosition|default('Main'), ttl: ttl}) }}" 
                           class="btn btn-sm btn-outline-info" target="_blank">
                            <i class="fas fa-code"></i> JSON
                        </a>
                        <a href="{{ path('debug_sym_banner_json') }}" 
                           class="btn btn-sm btn-outline-dark" target="_blank">
                            <i class="fas fa-database"></i> Raw FM JSON
                        </a>
                        <a href="{{ path('debug_banner_stats') }}" 
                           class="btn btn-sm btn-outline-secondary" target="_blank">
                            <i class="fas fa-chart-bar"></i> Stats
                        </a>
                    </div>
                </div>
                <div class="card-body">

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label"><strong>Banner Position:</strong></label>
                            <div class="btn-group d-flex flex-wrap" role="group">
                                {% for position in allPositions %}
                                    <a href="{{ path('debug_banner', {position: position, ttl: ttl}) }}" 
                                       class="btn btn-sm {{ position == currentPosition ? 'btn-primary' : 'btn-outline-secondary' }}">
                                        {{ position }}
                                    </a>
                                {% endfor %}
                                {% if allPositions is empty %}
                                    <span class="text-muted">Keine Positionen verfügbar</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <label class="form-label"><strong>Cache TTL:</strong></label>
                            <div class="btn-group" role="group">
                                <a href="{{ path('debug_banner', {position: currentPosition|default('Main'), ttl: 0}) }}" 
                                   class="btn btn-sm {{ ttl == 0 ? 'btn-warning' : 'btn-outline-warning' }}">
                                    Fresh (0s)
                                </a>
                                <a href="{{ path('debug_banner', {position: currentPosition|default('Main'), ttl: 300}) }}" 
                                   class="btn btn-sm {{ ttl == 300 ? 'btn-success' : 'btn-outline-success' }}">
                                    Cached (5min)
                                </a>
                            </div>
                            <div class="btn-group ms-2" role="group" aria-label="Aktiv filter">
                                <a href="{{ path('debug_banner', {position: currentPosition|default('Main'), ttl: ttl}) }}" 
                                   class="btn btn-sm {{ aktiv is not defined or aktiv == null or aktiv == '' ? 'btn-primary' : 'btn-outline-primary' }}">
                                    All
                                </a>
                                <a href="{{ path('debug_banner', {position: currentPosition|default('Main'), ttl: ttl, aktiv: '1'}) }}" 
                                   class="btn btn-sm {{ aktiv == '1' ? 'btn-success' : 'btn-outline-success' }}">
                                    Aktiv = 1
                                </a>
                            </div>
                        </div>
                    </div>

                    {# Inline Raw JSON Viewer #}
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0"><i class="fas fa-code-branch"></i> Inline Raw FM JSON</h5>
                        <div class="btn-group">
                            <button id="btnFetchRaw" class="btn btn-sm btn-outline-dark">Fetch Raw JSON</button>
                            <button id="btnToggleRaw" class="btn btn-sm btn-outline-secondary">Toggle Viewer</button>
                        </div>
                    </div>

                    <div id="rawJsonViewer" class="card mb-4" style="display:none;">
                        <div class="card-body">
                            <form id="rawJsonForm" class="row g-2 mb-3">
                                <div class="col-auto">
                                    <label class="form-label">Position</label>
                                    <input type="text" id="rawPosition" class="form-control" value="{{ currentPosition|default('Main') }}" />
                                </div>
                                <div class="col-auto">
                                    <label class="form-label">Aktiv</label>
                                        <select id="rawAktiv" class="form-select">
                                            <option value="" {{ aktiv is not defined or aktiv == null or aktiv == '' ? 'selected' : '' }}>Any</option>
                                            <option value="1" {{ aktiv == '1' ? 'selected' : '' }}>1 (Aktiv)</option>
                                            <option value="0" {{ aktiv == '0' ? 'selected' : '' }}>0 (Inaktiv)</option>
                                        </select>
                                </div>
                                <div class="col-auto">
                                    <label class="form-label">Limit</label>
                                    <input type="number" id="rawLimit" class="form-control" value="50" min="1" />
                                </div>
                                <div class="col-auto align-self-end">
                                    <button id="rawFetchNow" class="btn btn-sm btn-primary">Fetch</button>
                                </div>
                            </form>

                            <pre id="rawJsonOutput" class="prewrap" style="max-height:500px;overflow:auto;background:#f8f9fa;padding:12px;border-radius:6px;border:1px solid #e9ecef">{}</pre>
                        </div>
                    </div>

                    {% if stats %}
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Banner Statistiken:</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Gesamt:</strong> {{ stats.total }}
                            </div>
                            <div class="col-md-3">
                                <strong>Aktiv:</strong> {{ stats.active }}
                            </div>
                            <div class="col-md-6">
                                <strong>Positionen:</strong> 
                                {% for pos, counts in stats.positions %}
                                    <span class="badge bg-secondary me-1">{{ pos }} ({{ counts.active }}/{{ counts.total }})</span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <h5>
                        Banner für Position "{{ currentPosition|default('Main') }}" 
                        <span class="badge bg-success">{{ banners|length }} gefunden</span>
                    </h5>

                    {% if banners is empty %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            Keine Banner für Position "{{ currentPosition|default('Main') }}" gefunden.
                            <br><small>Überprüfe, dass Banner mit Aktiv = 1 und position = "{{ currentPosition|default('Main') }}" in FileMaker existieren.</small>
                        </div>
                    {% else %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Sortorder</th>
                                        <th>Titel</th>
                                        <th>Untertitel</th>
                                        <th>Bezeichnung</th>
                                        <th>Bild / Quelle</th>
                                        <th>Link</th>
                                        <th>Button Text</th>
                                        <th>Position</th>
                                        <th>Aktiv</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for banner in banners %}
                                    <tr>
                                        <td><code>{{ banner.id }}</code></td>
                                        <td>
                                            <span class="badge bg-info">{{ banner.sortorder }}</span>
                                        </td>
                                        <td>
                                            <strong>{{ banner.title ?: '(leer)' }}</strong>
                                        </td>
                                        <td>
                                            <span class="text-muted">{{ banner.subtitle ?: '(leer)' }}</span>
                                        </td>
                                        <td>
                                            {% if banner.bezeichnung %}
                                                <small>{{ banner.bezeichnung|slice(0, 80) }}{% if banner.bezeichnung|length > 80 %}...{% endif %}</small>
                                            {% else %}
                                                <span class="text-muted">(leer)</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if banner.source %}
                                                <code class="small">{{ banner.source|slice(0, 40) }}{% if banner.source|length > 40 %}...{% endif %}</code>
                                                {% if banner.alt_tag %}
                                                    <div class="text-muted small">alt: {{ banner.alt_tag }}</div>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">(leer)</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if banner.link %}
                                                <a href="{{ banner.link }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-external-link-alt"></i>
                                                </a>
                                            {% else %}
                                                <span class="text-muted">(leer)</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ banner.button_text ?: 'View Collection' }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">{{ banner.position }}</span>
                                        </td>
                                        <td>
                                            {% if banner.aktiv == '1' %}
                                                <span class="badge bg-success">Aktiv</span>
                                            {% else %}
                                                <span class="badge bg-danger">Inaktiv</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        {# Banner Preview #}
                        <hr>
                        <h5><i class="fas fa-eye"></i> Banner Vorschau (Template-Struktur)</h5>
                        <div class="row">
                            {% for banner in banners %}
                            <div class="col-lg-4 col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header">
                                        <small class="text-muted">Banner #{{ banner.id }} (Sortorder: {{ banner.sortorder }})</small>
                                    </div>
                                    <div class="card-body">
                                        {% if banner.subtitle %}
                                            <p class="card-text"><small class="text-muted">{{ banner.subtitle }}</small></p>
                                        {% endif %}
                                        {% if banner.title %}
                                            <h6 class="card-title">{{ banner.title }}</h6>
                                        {% endif %}
                                        {% if banner.description %}
                                            <p class="card-text">{{ banner.description }}</p>
                                        {% endif %}
                                        {% if banner.image %}
                                            <div class="text-center mb-2">
                                                <small class="text-muted">Bild: {{ banner.image }}</small>
                                            </div>
                                        {% endif %}
                                        {% if banner.link %}
                                            <a href="{{ banner.link }}" class="btn btn-primary btn-sm" target="_blank">
                                                {{ banner.button_text ?: 'View Collection' }}
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        (function(){
            const viewer = document.getElementById('rawJsonViewer');
            const btnToggle = document.getElementById('btnToggleRaw');
            const btnFetch = document.getElementById('btnFetchRaw');
            const rawPosition = document.getElementById('rawPosition');
            const rawAktiv = document.getElementById('rawAktiv');
            const rawLimit = document.getElementById('rawLimit');
            const rawOutput = document.getElementById('rawJsonOutput');
            const rawFetchNow = document.getElementById('rawFetchNow');

            function toggleViewer(){
                if(!viewer) return;
                viewer.style.display = (viewer.style.display === 'none' ? 'block' : 'none');
            }

            async function fetchRaw(){
                if(!rawOutput) return;
                rawOutput.textContent = 'Fetching...';
                const params = new URLSearchParams();
                if(rawPosition && rawPosition.value) params.set('position', rawPosition.value);
                if(rawAktiv && rawAktiv.value !== '') params.set('aktiv', rawAktiv.value);
                if(rawLimit && rawLimit.value) params.set('limit', rawLimit.value);

                try{
                    const res = await fetch(`{{ path('debug_banner_raw_json') }}?${params.toString()}`, { credentials: 'same-origin' });
                    const json = await res.json();
                    rawOutput.textContent = JSON.stringify(json, null, 2);
                }catch(err){
                    rawOutput.textContent = 'Error: ' + (err.message || err);
                }
            }

            if(btnToggle) btnToggle.addEventListener('click', (e)=>{ e.preventDefault(); toggleViewer(); });
            if(btnFetch) btnFetch.addEventListener('click', (e)=>{ e.preventDefault(); fetchRaw(); if(viewer) viewer.style.display = 'block'; });
            if(rawFetchNow) rawFetchNow.addEventListener('click', (e)=>{ e.preventDefault(); fetchRaw(); });

        })();
    </script>
{% endblock %}